# Backend Deployment Guide

This guide covers deploying the AI Finance Tracker backend to Render or Fly.io.

## Prerequisites

- GitHub account with this repository
- Supabase project set up with database schema
- AI Agent API key (if using AI insights feature)
- Deployment platform account (Render or Fly.io)

## Option 1: Deploy to Render (Recommended for Beginners)

### Step 1: Prepare Repository

The `render.yaml` file in the root directory contains the deployment configuration.

### Step 2: Connect to Render

1. Log in to [Render](https://render.com)
2. Click "New" → "Blueprint"
3. Connect your GitHub repository
4. Render will detect `render.yaml` automatically

### Step 3: Configure Environment Variables

Set these in Render dashboard under **Environment**:

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `SUPABASE_URL` | Your Supabase project URL | Yes | `https://xxxxx.supabase.co` |
| `SUPABASE_ANON_KEY` | Supabase anonymous key | Yes | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `SUPABASE_SERVICE_KEY` | Supabase service role key | Yes | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `JWT_SECRET` | Secret for JWT signing | Yes | Auto-generated by Render |
| `AI_AGENT_API_KEY` | API key for AI agent | No | Your AI agent key |
| `FRONTEND_URL` | Frontend URL for CORS | Yes | `https://your-app.netlify.app` |

**Important**: 
- Get Supabase keys from your Supabase project settings → API
- `JWT_SECRET` is auto-generated by Render
- Set `FRONTEND_URL` after deploying frontend

### Step 4: Deploy

1. Click "Apply" to create the service
2. Render will build and deploy automatically
3. Monitor build logs for errors
4. Once deployed, you'll get a URL like `https://ai-finance-tracker-backend.onrender.com`

### Step 5: Verify Deployment

Test the health endpoint:
```bash
curl https://your-backend-url.onrender.com/health
```

Expected response:
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "database": {
    "connected": true,
    "latency": 45,
    "message": "Database connection successful"
  }
}
```

### Render-Specific Notes

- **Free tier**: Service spins down after 15 minutes of inactivity
- **Cold starts**: First request after spin-down takes 30-60 seconds
- **Automatic deploys**: Enabled by default on `main` branch pushes
- **Logs**: Available in dashboard under "Logs" tab
- **Custom domain**: Configure in "Settings" → "Custom Domain"

## Option 2: Deploy to Fly.io (Better Performance)

### Step 1: Install Fly CLI

```bash
# macOS/Linux
curl -L https://fly.io/install.sh | sh

# Windows (PowerShell)
iwr https://fly.io/install.ps1 -useb | iex
```

### Step 2: Authenticate

```bash
fly auth login
```

### Step 3: Create App

```bash
cd backend
fly launch --config ../fly.toml --no-deploy
```

This creates the app without deploying yet.

### Step 4: Set Secrets

```bash
fly secrets set SUPABASE_URL=your_supabase_url
fly secrets set SUPABASE_ANON_KEY=your_supabase_anon_key
fly secrets set SUPABASE_SERVICE_KEY=your_supabase_service_key
fly secrets set JWT_SECRET=$(openssl rand -base64 32)
fly secrets set AI_AGENT_API_KEY=your_ai_agent_api_key
fly secrets set FRONTEND_URL=https://your-frontend.netlify.app
```

### Step 5: Deploy

```bash
fly deploy --config ../fly.toml
```

### Step 6: Verify Deployment

```bash
fly status
fly logs
curl https://your-app.fly.dev/health
```

### Fly.io-Specific Notes

- **Auto-scaling**: Machines start/stop based on traffic
- **Global deployment**: Can deploy to multiple regions
- **Better performance**: No cold starts like Render free tier
- **Pricing**: Pay-as-you-go, free allowance included
- **Monitoring**: Built-in metrics and logging

## Post-Deployment Configuration

### 1. Update Frontend Environment

Update `VITE_API_URL` in Netlify to point to your deployed backend:
```
VITE_API_URL=https://your-backend-url.onrender.com
```

### 2. Configure CORS

The backend automatically allows the `FRONTEND_URL` environment variable. Verify it's set correctly.

### 3. Test API Endpoints

```bash
# Health check
curl https://your-backend-url/health

# API root
curl https://your-backend-url/api

# Test authentication (should return 401)
curl https://your-backend-url/api/transactions
```

### 4. Monitor Logs

**Render:**
```
Dashboard → Logs tab
```

**Fly.io:**
```bash
fly logs
```

## Troubleshooting

### Build Fails

**Check TypeScript compilation:**
```bash
cd backend
npm run build
```

**Common issues:**
- Missing dependencies in `package.json`
- TypeScript errors
- Node version mismatch (use Node 18)

### Database Connection Fails

**Verify Supabase credentials:**
1. Check environment variables are set correctly
2. Ensure no trailing slashes in `SUPABASE_URL`
3. Verify keys are from the correct Supabase project
4. Check Supabase project is not paused

**Test locally:**
```bash
cd backend
npm run dev
curl http://localhost:5000/health
```

### Health Check Fails

**Render:**
- Check health check path is `/health`
- Verify port matches `PORT` environment variable (5000)

**Fly.io:**
- Check `fly.toml` health check configuration
- Verify internal port is 8080
- Check logs: `fly logs`

### CORS Errors

**Symptoms:** Frontend can't connect to backend

**Solutions:**
1. Verify `FRONTEND_URL` environment variable is set
2. Ensure no trailing slash in `FRONTEND_URL`
3. Check backend logs for CORS errors
4. Verify frontend is using correct `VITE_API_URL`

### 500 Internal Server Errors

**Check logs for:**
- Database connection errors
- Missing environment variables
- Unhandled exceptions

**Debug:**
```bash
# Render
Check dashboard logs

# Fly.io
fly logs --app your-app-name
```

## Continuous Deployment

### Automatic Deploys (Render)

Enabled by default in `render.yaml`:
- Deploys on push to `main` branch
- Can configure branch in dashboard

### Automatic Deploys (Fly.io)

Set up GitHub Actions (see CI/CD section in main deployment docs).

## Rollback

### Render

1. Go to "Deploys" in dashboard
2. Find previous working deploy
3. Click "Rollback to this version"

### Fly.io

```bash
# List releases
fly releases

# Rollback to previous version
fly releases rollback
```

## Monitoring & Alerts

### Render

- **Uptime monitoring**: Built-in
- **Alerts**: Configure in "Settings" → "Alerts"
- **Metrics**: CPU, memory, request count

### Fly.io

- **Metrics**: `fly dashboard`
- **Alerts**: Configure via Fly.io dashboard
- **Logs**: `fly logs --app your-app-name`

## Scaling

### Render

Upgrade plan for:
- No cold starts
- More CPU/memory
- Multiple instances

### Fly.io

```bash
# Scale instances
fly scale count 2

# Scale VM size
fly scale vm shared-cpu-2x
```

## Security Best Practices

1. **Never commit secrets**: Use environment variables
2. **Rotate keys regularly**: Especially if exposed
3. **Use HTTPS**: Automatic with both platforms
4. **Enable rate limiting**: Already configured in code
5. **Monitor logs**: Watch for suspicious activity
6. **Keep dependencies updated**: Run `npm audit` regularly

## Cost Optimization

### Render Free Tier
- Service spins down after 15 min inactivity
- 750 hours/month free
- Upgrade to prevent spin-down

### Fly.io Free Tier
- 3 shared-cpu-1x VMs
- 160GB outbound data transfer
- Auto-stop when idle

## Support Resources

- [Render Documentation](https://render.com/docs)
- [Fly.io Documentation](https://fly.io/docs)
- [Supabase Documentation](https://supabase.com/docs)
- Project README for application-specific issues

## Deployment Checklist

- [ ] Supabase database schema deployed
- [ ] Environment variables configured
- [ ] Backend deployed and health check passes
- [ ] Frontend `VITE_API_URL` updated
- [ ] CORS configured correctly
- [ ] API endpoints tested
- [ ] Logs monitored for errors
- [ ] Automatic deployments configured
- [ ] Monitoring/alerts set up
- [ ] Documentation updated with URLs
